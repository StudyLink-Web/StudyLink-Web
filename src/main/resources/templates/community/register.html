<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content" class="content_box">
    <h1>취준생 커뮤니티 등록하기</h1>

    <form th:action="@{/community/register}" method="post" enctype="multipart/form-data">
        <input type="hidden" name="_csrf" th:value="${_csrf.token}" />

        <div class="mb-3">
            <label for="title" class="form-label">제목</label>
            <input type="text" name="title" class="form-control" id="title"
                   placeholder="제목을 입력하세요." required>
        </div>

        <div class="mb-3">
            <label for="writer" class="form-label">작성자</label>
            <input type="text" name="writer" class="form-control" id="writer"
                   th:value="${#authentication != null ? #authentication.name : ''}"
                   readonly required>
        </div>

        <div class="mb-3">
            <label for="emailView" class="form-label">이메일</label>
            <input type="email" class="form-control" id="emailView"
                   th:value="${#authentication != null ? #authentication.name : ''}"
                   readonly>
        </div>

        <div class="mb-3">
            <label for="content" class="form-label">내용</label>
            <textarea class="form-control" name="content" id="content" rows="6"
                      placeholder="내용을 입력하세요." required></textarea>
        </div>

        <!-- ✅ input은 숨기고, 버튼만 노출 -->
        <div class="mb-3">
            <input type="file" name="files" id="file" multiple style="display:none">
            <button type="button" class="btn btn-outline-dark" id="trigger">file upload</button>
        </div>

        <div class="mb-3" id="fileZone"></div>

        <button type="submit" class="btn btn-primary" id="regBtn">register</button>
        <a th:href="@{/community/list}" class="btn btn-secondary">cancel</a>
    </form>

    <!-- ✅ 여기서는 "미리보기만" 처리 (중복 리스너 방지) -->
    <script th:inline="javascript">
        const fileInput = document.getElementById('file');
        const trigger = document.getElementById('trigger');
        const fileZone = document.getElementById('fileZone');

        trigger?.addEventListener('click', () => fileInput?.click());

        fileInput?.addEventListener('change', () => {
            fileZone.innerHTML = '';
            const files = Array.from(fileInput.files || []);
            if (!files.length) return;

            const ul = document.createElement('ul');
            ul.className = "list-group";
            files.forEach(f => {
                const li = document.createElement('li');
                li.className = "list-group-item";
                li.textContent = `${f.name} (${Math.round(f.size / 1024)}KB)`;
                ul.appendChild(li);
            });
            fileZone.appendChild(ul);
        });
    </script>

    <!-- ✅ communityRegister.js 안에서 trigger/file 이벤트를 또 걸고 있으면 2번 뜸.
         아래 한 줄을 제거하거나, communityRegister.js에서 trigger/file 관련 코드를 삭제해야 함. -->
    <!-- <script th:src="@{/js/communityRegister.js}"></script> -->
</div>

</html>
