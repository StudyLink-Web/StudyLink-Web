<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/layout}"
>
  <head>
    <meta charset="UTF-8" />
    <title>ë§ˆì´ ëŒ€ì‹œë³´ë“œ - StudyLink</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .dashboard-container {
        padding: 40px 0;
        background-color: #f4f7f6;
        min-height: calc(100vh - 150px);
      }
      .card {
        border-radius: 15px;
        border: none;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        background: #ffffff;
        margin-bottom: 25px;
      }
      .card-header {
        background: none;
        border-bottom: 1px solid #f1f1f1;
        padding: 20px 25px;
        font-weight: 700;
        font-size: 1.2rem;
        color: #333;
      }
      .card-body {
        padding: 25px;
      }
      .score-input-item {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 15px;
        border: 1px solid #eee;
        transition: all 0.2s;
      }
      .score-input-item:hover {
        border-color: #667eea;
        background: #fff;
      }
      .score-label {
        font-weight: 700;
        color: #444;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: space-between;
      }
      .analysis-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 300px;
        color: #adb5bd;
        text-align: center;
      }
      .btn-save {
        padding: 12px 30px;
        border-radius: 10px;
        font-weight: 600;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        transition: transform 0.2s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }
      .btn-save:hover {
        transform: translateY(-2px);
        color: white;
      }
      .analysis-section {
        opacity: 0;
        transition: opacity 0.5s;
      }
      .analysis-section.show {
        opacity: 1;
      }
      .score-type-select,
      .subject-select {
        border-radius: 8px;
        font-size: 0.9rem;
      }
      .score-value-input {
        border-radius: 8px;
        font-weight: 600;
        text-align: center;
      }
      .inquiry-group-label {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 15px;
        margin-bottom: 5px;
        padding-left: 5px;
        font-weight: 600;
      }
      .chart-container {
        position: relative;
        height: 250px;
        width: 100%;
      }
    </style>
  </head>

  <div layout:fragment="content" class="dashboard-container">
    <div class="container">
      <div class="row">
        <!-- ì™¼ìª½: ì„±ì  ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="col-lg-5">
          <div class="card h-100">
            <div class="card-header">
              <i class="fas fa-edit me-2"></i> ë‚˜ì˜ ì„±ì í‘œ ê´€ë¦¬
            </div>
            <div class="card-body">
              <p class="text-muted small mb-4">
                ê³¼ëª©ë³„ <strong>í‘œì¤€ì ìˆ˜</strong>, <strong>ë°±ë¶„ìœ„</strong> ë˜ëŠ”
                <strong>ë“±ê¸‰</strong>ì„ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”. ì •ë°€í•œ ì ìˆ˜ë¥¼
                ì…ë ¥í• ìˆ˜ë¡ AI ë¶„ì„ ê²°ê³¼ê°€ ë” ì •í™•í•´ì§‘ë‹ˆë‹¤.
              </p>

              <!-- ì„±ì  ì…ë ¥ í¼ -->
              <div id="scoreForm">
                <!-- êµ­ì–´ -->
                <div class="score-input-item" data-fixed-subject="êµ­ì–´">
                  <label class="score-label">
                    <div><span class="badge bg-dark">êµ­ì–´</span></div>
                    <select
                      class="form-select form-select-sm w-auto subject-detail-select"
                    >
                      <option value="">(ê³µí†µ)</option>
                      <option value="í™”ë²•ê³¼ ì‘ë¬¸">í™”ë²•ê³¼ ì‘ë¬¸</option>
                      <option value="ì–¸ì–´ì™€ ë§¤ì²´">ì–¸ì–´ì™€ ë§¤ì²´</option>
                    </select>
                  </label>
                  <div class="row g-2">
                    <div class="col-5">
                      <select
                        class="form-select score-type-select"
                        onchange="toggleHint(this)"
                      >
                        <option value="í‘œì ">í‘œì¤€ì ìˆ˜</option>
                        <option value="ë°±ë¶„ìœ„">ë°±ë¶„ìœ„</option>
                        <option value="ë“±ê¸‰">ë“±ê¸‰</option>
                      </select>
                    </div>
                    <div class="col-7">
                      <input
                        type="number"
                        class="form-control score-value-input"
                        placeholder="ì ìˆ˜ ì…ë ¥"
                        step="0.1"
                        value="100"
                      />
                    </div>
                  </div>
                </div>

                <!-- ìˆ˜í•™ -->
                <div class="score-input-item" data-fixed-subject="ìˆ˜í•™">
                  <label class="score-label">
                    <div><span class="badge bg-primary">ìˆ˜í•™</span></div>
                    <select
                      class="form-select form-select-sm w-auto subject-detail-select"
                    >
                      <option value="">(ê³µí†µ)</option>
                      <option value="í™•ë¥ ê³¼ í†µê³„">í™•ë¥ ê³¼ í†µê³„</option>
                      <option value="ë¯¸ì ë¶„">ë¯¸ì ë¶„</option>
                      <option value="ê¸°í•˜">ê¸°í•˜</option>
                    </select>
                  </label>
                  <div class="row g-2">
                    <div class="col-5">
                      <select
                        class="form-select score-type-select"
                        onchange="toggleHint(this)"
                      >
                        <option value="í‘œì ">í‘œì¤€ì ìˆ˜</option>
                        <option value="ë°±ë¶„ìœ„">ë°±ë¶„ìœ„</option>
                        <option value="ë“±ê¸‰">ë“±ê¸‰</option>
                      </select>
                    </div>
                    <div class="col-7">
                      <input
                        type="number"
                        class="form-control score-value-input"
                        placeholder="ì ìˆ˜ ì…ë ¥"
                        step="0.1"
                        value="100"
                      />
                    </div>
                  </div>
                </div>

                <!-- ì˜ì–´ -->
                <div class="score-input-item" data-fixed-subject="ì˜ì–´">
                  <label class="score-label"
                    ><span class="badge bg-success">ì˜ì–´</span></label
                  >
                  <div class="row g-2">
                    <div class="col-5">
                      <select
                        class="form-select score-type-select"
                        onchange="toggleHint(this)"
                      >
                        <option value="ë“±ê¸‰">ë“±ê¸‰(ì ˆëŒ€)</option>
                        <option value="ë°±ë¶„ìœ„">ë°±ë¶„ìœ„</option>
                      </select>
                    </div>
                    <div class="col-7">
                      <input
                        type="number"
                        class="form-control score-value-input"
                        placeholder="ë“±ê¸‰ ì…ë ¥"
                        step="1"
                        min="1"
                        max="9"
                        value="3"
                      />
                    </div>
                  </div>
                </div>

                <div class="inquiry-group-label">
                  <i class="fas fa-search me-1"></i> íƒêµ¬ ì˜ì—­ (ìµœëŒ€ 2ê³¼ëª© ì„ íƒ)
                </div>

                <!-- íƒêµ¬ 1 -->
                <div
                  class="score-input-item inquiry-item"
                  data-inquiry-index="1"
                >
                  <div class="score-label">
                    <span class="badge bg-warning text-dark">íƒêµ¬ 1</span>
                    <select
                      class="form-select form-select-sm subject-select w-auto"
                      onchange="updateCategory(this)"
                    >
                      <option value="">ê³¼ëª© ì„ íƒ</option>
                      <optgroup label="ì‚¬íšŒíƒêµ¬">
                        <option value="ìƒí™œê³¼ ìœ¤ë¦¬" data-cat="ì‚¬íƒ">
                          ìƒí™œê³¼ ìœ¤ë¦¬
                        </option>
                        <option value="ìœ¤ë¦¬ì™€ ì‚¬ìƒ" data-cat="ì‚¬íƒ">
                          ìœ¤ë¦¬ì™€ ì‚¬ìƒ
                        </option>
                        <option value="í•œêµ­ì§€ë¦¬" data-cat="ì‚¬íƒ">
                          í•œêµ­ì§€ë¦¬
                        </option>
                        <option value="ì„¸ê³„ì§€ë¦¬" data-cat="ì‚¬íƒ">
                          ì„¸ê³„ì§€ë¦¬
                        </option>
                        <option value="ë™ì•„ì‹œì•„ì‚¬" data-cat="ì‚¬íƒ">
                          ë™ì•„ì‹œì•„ì‚¬
                        </option>
                        <option value="ì„¸ê³„ì‚¬" data-cat="ì‚¬íƒ">ì„¸ê³„ì‚¬</option>
                        <option value="ê²½ì œ" data-cat="ì‚¬íƒ">ê²½ì œ</option>
                        <option value="ì •ì¹˜ì™€ ë²•" data-cat="ì‚¬íƒ">
                          ì •ì¹˜ì™€ ë²•
                        </option>
                        <option value="ì‚¬íšŒÂ·ë¬¸í™”" data-cat="ì‚¬íƒ">
                          ì‚¬íšŒÂ·ë¬¸í™”
                        </option>
                      </optgroup>
                      <optgroup label="ê³¼í•™íƒêµ¬">
                        <option value="ë¬¼ë¦¬í•™â… " data-cat="ê³¼íƒ">ë¬¼ë¦¬í•™â… </option>
                        <option value="ë¬¼ë¦¬í•™â…¡" data-cat="ê³¼íƒ">ë¬¼ë¦¬í•™â…¡</option>
                        <option value="í™”í•™â… " data-cat="ê³¼íƒ">í™”í•™â… </option>
                        <option value="í™”í•™â…¡" data-cat="ê³¼íƒ">í™”í•™â…¡</option>
                        <option value="ìƒëª…ê³¼í•™â… " data-cat="ê³¼íƒ">
                          ìƒëª…ê³¼í•™â… 
                        </option>
                        <option value="ìƒëª…ê³¼í•™â…¡" data-cat="ê³¼íƒ">
                          ìƒëª…ê³¼í•™â…¡
                        </option>
                        <option value="ì§€êµ¬ê³¼í•™â… " data-cat="ê³¼íƒ">
                          ì§€êµ¬ê³¼í•™â… 
                        </option>
                        <option value="ì§€êµ¬ê³¼í•™â…¡" data-cat="ê³¼íƒ">
                          ì§€êµ¬ê³¼í•™â…¡
                        </option>
                      </optgroup>
                    </select>
                  </div>
                  <div class="row g-2 mt-1">
                    <div class="col-5">
                      <select
                        class="form-select score-type-select"
                        onchange="toggleHint(this)"
                      >
                        <option value="í‘œì ">í‘œì¤€ì ìˆ˜</option>
                        <option value="ë°±ë¶„ìœ„">ë°±ë¶„ìœ„</option>
                        <option value="ë“±ê¸‰">ë“±ê¸‰</option>
                      </select>
                    </div>
                    <div class="col-7">
                      <input
                        type="number"
                        class="form-control score-value-input"
                        placeholder="ì ìˆ˜"
                        step="0.1"
                        value="50"
                      />
                    </div>
                  </div>
                </div>

                <!-- íƒêµ¬ 2 -->
                <div
                  class="score-input-item inquiry-item"
                  data-inquiry-index="2"
                >
                  <div class="score-label">
                    <span class="badge bg-warning text-dark">íƒêµ¬ 2</span>
                    <select
                      class="form-select form-select-sm subject-select w-auto"
                      onchange="updateCategory(this)"
                    >
                      <option value="">ê³¼ëª© ì„ íƒ</option>
                      <optgroup label="ì‚¬íšŒíƒêµ¬">
                        <option value="ìƒí™œê³¼ ìœ¤ë¦¬" data-cat="ì‚¬íƒ">
                          ìƒí™œê³¼ ìœ¤ë¦¬
                        </option>
                        <option value="ìœ¤ë¦¬ì™€ ì‚¬ìƒ" data-cat="ì‚¬íƒ">
                          ìœ¤ë¦¬ì™€ ì‚¬ìƒ
                        </option>
                        <option value="í•œêµ­ì§€ë¦¬" data-cat="ì‚¬íƒ">
                          í•œêµ­ì§€ë¦¬
                        </option>
                        <option value="ì„¸ê³„ì§€ë¦¬" data-cat="ì‚¬íƒ">
                          ì„¸ê³„ì§€ë¦¬
                        </option>
                        <option value="ë™ì•„ì‹œì•„ì‚¬" data-cat="ì‚¬íƒ">
                          ë™ì•„ì‹œì•„ì‚¬
                        </option>
                        <option value="ì„¸ê³„ì‚¬" data-cat="ì‚¬íƒ">ì„¸ê³„ì‚¬</option>
                        <option value="ê²½ì œ" data-cat="ì‚¬íƒ">ê²½ì œ</option>
                        <option value="ì •ì¹˜ì™€ ë²•" data-cat="ì‚¬íƒ">
                          ì •ì¹˜ì™€ ë²•
                        </option>
                        <option value="ì‚¬íšŒÂ·ë¬¸í™”" data-cat="ì‚¬íƒ">
                          ì‚¬íšŒÂ·ë¬¸í™”
                        </option>
                      </optgroup>
                      <optgroup label="ê³¼í•™íƒêµ¬">
                        <option value="ë¬¼ë¦¬í•™â… " data-cat="ê³¼íƒ">ë¬¼ë¦¬í•™â… </option>
                        <option value="ë¬¼ë¦¬í•™â…¡" data-cat="ê³¼íƒ">ë¬¼ë¦¬í•™â…¡</option>
                        <option value="í™”í•™â… " data-cat="ê³¼íƒ">í™”í•™â… </option>
                        <option value="í™”í•™â…¡" data-cat="ê³¼íƒ">í™”í•™â…¡</option>
                        <option value="ìƒëª…ê³¼í•™â… " data-cat="ê³¼íƒ">
                          ìƒëª…ê³¼í•™â… 
                        </option>
                        <option value="ìƒëª…ê³¼í•™â…¡" data-cat="ê³¼íƒ">
                          ìƒëª…ê³¼í•™â…¡
                        </option>
                        <option value="ì§€êµ¬ê³¼í•™â… " data-cat="ê³¼íƒ">
                          ì§€êµ¬ê³¼í•™â… 
                        </option>
                        <option value="ì§€êµ¬ê³¼í•™â…¡" data-cat="ê³¼íƒ">
                          ì§€êµ¬ê³¼í•™â…¡
                        </option>
                      </optgroup>
                    </select>
                  </div>
                  <div class="row g-2 mt-1">
                    <div class="col-5">
                      <select
                        class="form-select score-type-select"
                        onchange="toggleHint(this)"
                      >
                        <option value="í‘œì ">í‘œì¤€ì ìˆ˜</option>
                        <option value="ë°±ë¶„ìœ„">ë°±ë¶„ìœ„</option>
                        <option value="ë“±ê¸‰">ë“±ê¸‰</option>
                      </select>
                    </div>
                    <div class="col-7">
                      <input
                        type="number"
                        class="form-control score-value-input"
                        placeholder="ì ìˆ˜"
                        step="0.1"
                        value="50"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <!-- ì„±ì  ì œëª© ì…ë ¥ ë° ì €ì¥ êµ¬ì—­ -->
              <div class="mt-4 pt-3 border-top">
                <div class="mb-3">
                  <label class="form-label small fw-bold text-muted"
                    >ë¶„ì„ ì„±ì  ì œëª© (ì„ íƒ)</label
                  >
                  <input
                    type="text"
                    id="recordTitle"
                    class="form-control form-control-sm"
                    placeholder="ì˜ˆ: 2024_03_ëª¨ì˜ê³ ì‚¬"
                  />
                </div>
                <div class="d-grid gap-2">
                  <button class="btn btn-save" onclick="saveScores()">
                    <i class="fas fa-save me-2"></i> ì„±ì  ì €ì¥ ë° ë¶„ì„í•˜ê¸°
                  </button>
                </div>
              </div>

              <!-- ì €ì¥ëœ ì„±ì  ì´ë ¥ (ìµœì‹  5ê°œ) -->
              <div id="scoreHistoryArea" class="mt-4 d-none">
                <h6 class="fw-bold small text-muted mb-2">
                  <i class="fas fa-history me-1"></i> ì €ì¥ëœ ì„±ì  ì´ë ¥
                </h6>
                <div
                  id="recordList"
                  class="list-group list-group-flush small border rounded"
                >
                  <!-- ë™ì  ì‚½ì…ë¨ -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ë¶„ì„ ë¦¬í¬íŠ¸ ì„¹ì…˜ -->
        <div class="col-lg-7">
          <div class="card h-100">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <span
                ><i class="fas fa-chart-pie me-2"></i> AI ì…ì‹œ ë¶„ì„ ë¦¬í¬íŠ¸</span
              >
              <span
                id="analysisStatus"
                class="badge bg-light text-dark fw-normal"
                style="font-size: 0.75rem"
                >ë°ì´í„° ë¶„ì„ ëŒ€ê¸° ì¤‘</span
              >
            </div>
            <div class="card-body">
              <div id="noDataArea" class="analysis-placeholder">
                <i class="fas fa-robot fa-4x mb-3" style="opacity: 0.1"></i>
                <p>
                  ì„±ì ì„ ì €ì¥í•˜ë©´ AIê°€ ì§€ì› ê°€ëŠ¥ê¶Œ ëŒ€í•™ì„<br />ì‹œê°ì ìœ¼ë¡œ ë¶„ì„í•´
                  ë“œë¦½ë‹ˆë‹¤.
                </p>
              </div>

              <div id="analysisArea" class="analysis-section d-none">
                <div class="row">
                  <div class="col-md-6 mb-4">
                    <h6 class="fw-bold small text-muted mb-3">
                      ì¢…í•© í•©ê²©ê¶Œ ë¶„í¬
                      <i
                        class="fas fa-info-circle"
                        title="í˜„ì¬ ì„±ì ìœ¼ë¡œ ì§€ì› ê°€ëŠ¥í•œ ëŒ€í•™ë“¤ì˜ í•©ê²© ì•ˆì •ì„± ë¶„í¬ì…ë‹ˆë‹¤."
                      ></i>
                    </h6>
                    <div class="chart-container">
                      <canvas id="barChart"></canvas>
                    </div>
                  </div>
                  <div class="col-md-6 mb-4">
                    <h6 class="fw-bold small text-muted mb-3">
                      ì „í˜•ë³„ ì—­ëŸ‰ ë°¸ëŸ°ìŠ¤
                      <i
                        class="fas fa-info-circle"
                        title="ê³¼ëª©ë³„ ì„±ì ì„ ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„í•œ ì¸í…”ë¦¬ì „ìŠ¤ ì°¨íŠ¸ì…ë‹ˆë‹¤."
                      ></i>
                    </h6>
                    <div class="chart-container">
                      <canvas id="radarChart"></canvas>
                    </div>
                  </div>
                </div>
                <hr />
                <div class="mt-3">
                  <h6 class="fw-bold text-primary">
                    <i class="fas fa-magic me-2"></i> StudyLink AI ì…ì‹œ ì»¨ì„¤íŒ…
                  </h6>
                  <div
                    id="aiSummary"
                    class="alert alert-info py-3 mt-2"
                    style="
                      font-size: 0.95rem;
                      line-height: 1.7;
                      border: none;
                      background: #f0f7ff;
                      color: #333;
                    "
                  >
                    ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- â­ ìë°”ìŠ¤í¬ë¦½íŠ¸ëŠ” fragment ë‚´ë¶€ì— ìœ„ì¹˜ -->
    <script th:inline="javascript">
      const csrfToken = document.querySelector('meta[name="_csrf"]').content;
      const csrfHeader = document.querySelector(
        'meta[name="_csrf_header"]'
      ).content;

      let barChart = null;
      let radarChart = null;
      let analysisData = null; // ë¶„ì„ ë°ì´í„° ì „ì—­ ì €ì¥

      window.onload = function () {
        loadInitialData();
        fetchHistory(); // ì´ë ¥ ë¶ˆëŸ¬ì˜¤ê¸° ì¶”ê°€
      };

      async function fetchHistory() {
        try {
          const res = await fetch("/api/dashboard/records");
          if (!res.ok) return;
          const records = await res.json();
          const area = document.getElementById("scoreHistoryArea");
          const list = document.getElementById("recordList");

          if (records.length > 0) {
            area.classList.remove("d-none");
            list.innerHTML = "";
            records.slice(0, 5).forEach((r) => {
              const date = new Date(r.createdAt).toLocaleDateString();
              const item = document.createElement("a");
              item.href = "javascript:void(0)";
              item.className =
                "list-group-item list-group-item-action d-flex justify-content-between align-items-center py-2";
              item.innerHTML = `
                <span class="text-truncate" style="max-width: 150px;">${r.title}</span>
                <span class="text-muted" style="font-size: 0.7rem;">${date}</span>
              `;
              item.onclick = () => loadRecord(r.id, r.title);
              list.appendChild(item);
            });
          }
        } catch (e) {
          console.error("ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨:", e);
        }
      }

      async function loadRecord(id, title) {
        if (
          !confirm(
            `'${title}' ì„±ì ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ì…ë ¥ëœ ë‚´ìš©ì€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.`
          )
        )
          return;

        try {
          const res = await fetch(`/api/dashboard/records/${id}/load`);
          if (!res.ok) throw new Error("ë¡œë“œ ì‹¤íŒ¨");
          const scores = await res.json();

          // ê¸°ì¡´ UI ì´ˆê¸°í™” í›„ ë°ì´í„° ì‚½ì…
          populateScoreFields(scores);
          document.getElementById("recordTitle").value = title;

          // ë¶„ì„ ìš”ì²­
          requestAnalysis();
        } catch (e) {
          alert("ì„±ì ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      function populateScoreFields(scores) {
        let inquiryIdx = 1;

        // íƒêµ¬ í•„ë“œ ì´ˆê¸°í™” (ê³¼ëª© ì„ íƒ í•´ì œ)
        document
          .querySelectorAll(".inquiry-item .subject-select")
          .forEach((s) => (s.value = ""));

        scores.forEach((s) => {
          const fixedItem = document.querySelector(
            `.score-input-item[data-fixed-subject="${s.subject_name}"]`
          );
          if (fixedItem) {
            fixedItem.querySelector(".score-type-select").value = s.score_type;
            fixedItem.querySelector("input").value = s.score;
            const detailSelect = fixedItem.querySelector(
              ".subject-detail-select"
            );
            if (detailSelect && s.optional_subject)
              detailSelect.value = s.optional_subject;
            toggleHint(fixedItem.querySelector(".score-type-select"));
          } else if (s.category === "ì‚¬íƒ" || s.category === "ê³¼íƒ") {
            const inqItem = document.querySelector(
              `.inquiry-item[data-inquiry-index="${inquiryIdx}"]`
            );
            if (inqItem) {
              inqItem.querySelector(".subject-select").value = s.subject_name;
              inqItem.querySelector(".score-type-select").value = s.score_type;
              inqItem.querySelector(".score-value-input").value = s.score;
              toggleHint(inqItem.querySelector(".score-type-select"));
              inquiryIdx++;
            }
          }
        });
      }

      function toggleHint(select) {
        const input = select.closest(".row").querySelector("input");
        if (select.value === "ë“±ê¸‰") {
          input.placeholder = "1~9 ì…ë ¥";
          input.step = "1";
        } else if (select.value === "ë°±ë¶„ìœ„") {
          input.placeholder = "0~100 ì…ë ¥";
          input.step = "0.1";
        } else {
          input.placeholder = "í‘œì  ì…ë ¥";
          input.step = "0.1";
        }
      }

      function updateCategory(select) {
        // í•„ìš” ì‹œ ê³¼ëª© ì„ íƒì— ë”°ë¥¸ ë¶€ê°€ ë¡œì§ (í˜„ì¬ëŠ” save ì‹œ optionì˜ data-catì„ ì§ì ‘ ì½ìŒ)
      }

      async function loadInitialData() {
        try {
          const res = await fetch("/api/dashboard/data");
          if (!res.ok) return;
          const data = await res.json();
          console.log("ğŸ” [Frontend] Loaded Dashboard Data:", data);

          if (data.scores && data.scores.length > 0) {
            let inquiryIdx = 1;
            data.scores.forEach((s) => {
              // ê³ ì • ê³¼ëª© (êµ­ì–´, ìˆ˜í•™, ì˜ì–´)
              const fixedItem = document.querySelector(
                `.score-input-item[data-fixed-subject="${s.subject_name}"]`
              );
              if (fixedItem) {
                fixedItem.querySelector(".score-type-select").value =
                  s.score_type;
                fixedItem.querySelector("input").value = s.score;
                const detailSelect = fixedItem.querySelector(
                  ".subject-detail-select"
                );
                if (detailSelect && s.optional_subject) {
                  detailSelect.value = s.optional_subject;
                }
                toggleHint(fixedItem.querySelector(".score-type-select"));
              } else if (s.category === "ì‚¬íƒ" || s.category === "ê³¼íƒ") {
                // íƒêµ¬ ê³¼ëª©
                const inqItem = document.querySelector(
                  `.inquiry-item[data-inquiry-index="${inquiryIdx}"]`
                );
                if (inqItem) {
                  inqItem.querySelector(".subject-select").value =
                    s.subject_name;
                  inqItem.querySelector(".score-type-select").value =
                    s.score_type;
                  inqItem.querySelector(".score-value-input").value = s.score;
                  toggleHint(inqItem.querySelector(".score-type-select"));
                  inquiryIdx++;
                }
              }
            });
            requestAnalysis();
          }
        } catch (e) {
          console.error("ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", e);
        }
      }

      async function saveScores() {
        const scores = [];

        // 1. ê³ ì • ê³¼ëª© ìˆ˜ì§‘
        document
          .querySelectorAll(".score-input-item[data-fixed-subject]")
          .forEach((item) => {
            const subj = item.getAttribute("data-fixed-subject");
            if (subj) {
              scores.push({
                subject_name: subj,
                score_type: item.querySelector(".score-type-select").value,
                score: parseFloat(item.querySelector("input").value),
                category: "ê³µí†µ",
                optional_subject:
                  item.querySelector(".subject-detail-select")?.value || null,
              });
            }
          });

        // 2. íƒêµ¬ ê³¼ëª© ìˆ˜ì§‘
        document.querySelectorAll(".inquiry-item").forEach((item) => {
          const subjectSelect = item.querySelector(".subject-select");
          const subjectName = subjectSelect.value;
          if (subjectName) {
            const selectedOption =
              subjectSelect.options[subjectSelect.selectedIndex];
            scores.push({
              subject_name: subjectName,
              score_type: item.querySelector(".score-type-select").value,
              score: parseFloat(item.querySelector(".score-value-input").value),
              category: selectedOption.dataset.cat,
            });
          }
        });

        // ìœ íš¨ì„± ê²€ì‚¬ (ê³¼ëª©ëª…ì´ ì—†ëŠ” ë°ì´í„°ëŠ” ì œì™¸)
        const validScores = scores.filter(
          (s) => s.subject_name && !isNaN(s.score)
        );
        console.log("ğŸ“¤ [Frontend] Saving Scores:", validScores);

        if (validScores.length === 0) {
          alert("ì…ë ¥ëœ ì„±ì  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì ìˆ˜ì™€ ê³¼ëª©ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
          return;
        }

        try {
          const res = await fetch("/api/dashboard/save", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              [csrfHeader]: csrfToken,
            },
            body: JSON.stringify(validScores),
          });

          // ì œëª©ì´ ìˆëŠ” ê²½ìš° ë ˆì½”ë“œë¡œë„ ì €ì¥
          const title = document.getElementById("recordTitle").value.trim();
          if (title) {
            await fetch("/api/dashboard/records/save", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                [csrfHeader]: csrfToken,
              },
              body: JSON.stringify({ title: title, scores: validScores }),
            });
            fetchHistory(); // ëª©ë¡ ê°±ì‹ 
          }

          const result = await res.json();
          if (res.ok) {
            alert(result.message || "ì„±ì ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            requestAnalysis();
          } else {
            console.error("âŒ ì €ì¥ ì‹¤íŒ¨:", result);
            alert("ì €ì¥ ì‹¤íŒ¨: " + (result.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
          }
        } catch (e) {
          console.error("âŒ ì €ì¥ ì¤‘ ì˜ˆì™¸ ë°œìƒ:", e);
          alert("ë°ì´í„° ì €ì¥ ì¤‘ ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function requestAnalysis() {
        const noDataArea = document.getElementById("noDataArea");
        const analysisArea = document.getElementById("analysisArea");
        const statusEl = document.getElementById("analysisStatus");

        noDataArea.classList.add("d-none");
        analysisArea.classList.remove("d-none");
        analysisArea.classList.add("show");
        statusEl.innerText = "AI ë°ì´í„° ë§ˆì´ë‹ ì¤‘...";

        try {
          const res = await fetch("/api/dashboard/analysis");
          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(
              errData.message || "ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨ (Status: " + res.status + ")"
            );
          }

          const data = await res.json();
          analysisData = data; // ë°ì´í„° ì €ì¥
          console.log("ğŸ“Š [Frontend] Received Analysis Data:", data);

          // ë°ì´í„° í•„ë“œëª… ì‹±í¬ (snake_case ëŒ€ì‘)
          renderCharts(data);

          const summaryText = data.ai_summary || data.aiSummary;
          document.getElementById("aiSummary").innerHTML = summaryText
            ? summaryText.replace(/\n/g, "<br>")
            : "ë¶„ì„ ìš”ì•½ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";

          statusEl.innerText = "ë¶„ì„ ì™„ë£Œ (2026í•™ë…„ë„ ì…ì‹œ ë°˜ì˜)";
        } catch (e) {
          console.error("âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜:", e);
          document.getElementById("aiSummary").innerText =
            "AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message;
          statusEl.innerText = "ë¶„ì„ ì˜¤ë¥˜";
        }
      }

      function renderCharts(data) {
        const chartData = data.chart_data || data.chartData;
        const radarData = data.radar_data || data.radarData;

        if (!chartData || !radarData) {
          console.warn("âš ï¸ ì°¨íŠ¸ ë°ì´í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤:", data);
          return;
        }

        const ctxBar = document.getElementById("barChart").getContext("2d");
        if (barChart) barChart.destroy();
        barChart = new Chart(ctxBar, {
          type: "bar",
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
            onClick: (event, elements, chart) => {
              const activePoints = chart.getElementsAtEventForMode(
                event.native || event,
                "nearest",
                { intersect: true },
                true
              );
              if (activePoints.length > 0) {
                const index = activePoints[0].index;
                const status = chart.data.labels[index];
                console.log("ğŸ–±ï¸ Chart Clicked:", status);
                showUnivList(status);
              }
            },
          },
        });

        const ctxRadar = document.getElementById("radarChart").getContext("2d");
        if (radarChart) radarChart.destroy();
        radarChart = new Chart(ctxRadar, {
          type: "radar",
          data: radarData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                angleLines: { display: true },
                suggestedMin: 0,
                suggestedMax: 10,
              },
            },
          },
        });
      }

      function showUnivList(status) {
        if (!analysisData) {
          console.error("âŒ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        const topUnivs =
          analysisData.top_universities || analysisData.topUniversities;
        if (!topUnivs) {
          console.error(
            "âŒ ëŒ€í•™ ìƒì„¸ ë°ì´í„°(top_universities)ê°€ ì‘ë‹µì— í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          );
          return;
        }

        const list = topUnivs[status] || [];
        const body = document.getElementById("univListBody");
        const title = document.getElementById("modalTitle");

        title.innerHTML = `<span class="badge ${getStatusBadgeClass(
          status
        )} me-2">${status}</span> ê¶Œ ì£¼ìš” ë¶„ì„ ëŒ€í•™`;
        body.innerHTML = "";

        if (list.length === 0) {
          body.innerHTML =
            '<tr><td colspan="4" class="text-center py-4 text-muted">í•´ë‹¹ êµ¬ê°„ì— ë¶„ì„ëœ ëŒ€í•™ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        } else {
          list.forEach((u) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="ps-4 fw-bold text-dark">${u.univ}</td>
                <td><span class="text-muted small">${u.major}</span></td>
                <td class="text-center"><span class="badge bg-light text-dark fw-normal">${
                  u.target_per
                }%</span></td>
                <td class="text-center"><span class="fw-bold ${getStatusTextClass(
                  status
                )}">${status}</span></td>
              `;
            body.appendChild(tr);
          });
        }

        const modalId = "univListModal";
        const modalEl = document.getElementById(modalId);

        // Bootstrap v5 ë°©ì‹ ì‹œë„ í›„ ì‹¤íŒ¨ ì‹œ v4(jQuery) ì‹œë„
        if (window.bootstrap && bootstrap.Modal) {
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
        } else if (window.jQuery && jQuery.fn.modal) {
          $(modalEl).modal("show");
        } else {
          console.error("âŒ Bootstrap Modal ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          alert("ìƒì„¸ ë¦¬ìŠ¤íŠ¸ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì˜¤ë¥˜).");
        }
      }

      function getStatusBadgeClass(status) {
        switch (status) {
          case "ì•ˆì •":
            return "bg-success";
          case "ì ì •":
            return "bg-primary";
          case "ì†Œì‹ ":
            return "bg-warning text-dark";
          case "ë¶ˆê°€":
            return "bg-danger";
          default:
            return "bg-secondary";
        }
      }

      function getStatusTextClass(status) {
        switch (status) {
          case "ì•ˆì •":
            return "text-success";
          case "ì ì •":
            return "text-primary";
          case "ì†Œì‹ ":
            return "text-warning";
          case "ë¶ˆê°€":
            return "text-danger";
          default:
            return "text-muted";
        }
      }
    </script>

    <!-- ğŸ“Š ëŒ€í•™ ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ (ìµœí•˜ë‹¨ìœ¼ë¡œ ì´ë™í•˜ì—¬ ë°°ê²½ ê²¹ì¹¨ ì´ìŠˆ í•´ê²°) -->
    <div
      class="modal fade"
      id="univListModal"
      tabindex="-1"
      aria-hidden="true"
      style="z-index: 2000"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="background: white">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title fw-bold" id="modalTitle">
              ë¶„ì„ ëŒ€í•™ ë¦¬ìŠ¤íŠ¸
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="ps-4">ëŒ€í•™êµ</th>
                    <th>í•™ê³¼/ì „ê³µ</th>
                    <th class="text-center">70% ì»·(ë°±ë¶„ìœ„)</th>
                    <th class="text-center">ì§„ë‹¨</th>
                  </tr>
                </thead>
                <tbody id="univListBody">
                  <!-- ë°ì´í„°ê°€ ë™ì ìœ¼ë¡œ ì‚½ì…ë¨ -->
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer border-0 bg-light">
            <p class="small text-muted mb-0 me-auto ps-2">
              â€» ìƒìœ„ 10ê°œ ëŒ€í•™ ì •ë³´ëŠ” ADIGA(ê³µê³µë°ì´í„°) 70% ì»· ê¸°ì¤€ì…ë‹ˆë‹¤.
            </p>
            <button
              type="button"
              class="btn btn-secondary btn-sm px-4"
              data-bs-dismiss="modal"
            >
              ë‹«ê¸°
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</html>
