<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content" class="content_box">

    <h1>문의 상세보기</h1>

    <div th:if="${inquiry == null}">
        <div class="alert alert-danger">존재하지 않는 문의입니다.</div>
        <a th:href="@{/inquiry/list}" class="btn btn-secondary">목록</a>
    </div>

    <div th:if="${inquiry != null}">

        <div class="mb-3">
            <label class="form-label">제목</label>
            <input type="text" class="form-control" th:value="${inquiry.title}" readonly>
        </div>

        <div class="mb-3 d-flex gap-3">
            <div style="flex:1">
                <label class="form-label">문의 유형</label>
                <input type="text" class="form-control"
                       th:value="${inquiry.choose != null ? inquiry.choose : '-'}" readonly>
            </div>
            <div style="flex:1">
                <label class="form-label">공개 여부</label>
                <input type="text" class="form-control"
                       th:value="${inquiry.isPublic == 'Y' ? '공개' : '비공개'}" readonly>
            </div>
            <div style="flex:1">
                <label class="form-label">상태</label>
                <input type="text" class="form-control"
                       th:value="${inquiry.status != null ? inquiry.status : '대기'}" readonly>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">문의 내용</label>
            <textarea class="form-control" rows="8" readonly
                      th:text="${inquiry.userContent}"></textarea>
        </div>

        <div class="mb-3 d-flex gap-3">
            <div>
                <small class="text-muted">등록일</small><br>
                <span th:text="${inquiry.createdAt != null ? #temporals.format(inquiry.createdAt, 'yyyy-MM-dd HH:mm') : '-'}"></span>
            </div>
            <div>
                <small class="text-muted">답변일</small><br>
                <span th:text="${inquiry.answerAt != null ? #temporals.format(inquiry.answerAt, 'yyyy-MM-dd HH:mm') : '-'}"></span>
            </div>
        </div>

        <div class="mb-3">
            <h4>관리자 답변</h4>

            <div th:if="${#strings.isEmpty(inquiry.adminContent)}">
                <p class="text-muted">아직 답변이 없습니다.</p>
            </div>

            <div th:if="${!#strings.isEmpty(inquiry.adminContent)}">
                <textarea class="form-control" rows="6" readonly
                          th:text="${inquiry.adminContent}"></textarea>
            </div>
        </div>

        <!-- ✅ 관리자 답변 입력 폼: 관리자 + 아직 답변 없을 때만 보이기 -->
        <div sec:authorize="hasAnyAuthority('ADMIN','ROLE_ADMIN')"
             th:if="${#strings.isEmpty(inquiry.adminContent)}">

            <form th:action="@{/inquiry/answer}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" name="qno" th:value="${inquiry.qno}"/>

                <div class="mb-3">
                    <label class="form-label">답변 작성</label>
                    <textarea class="form-control" rows="6" name="adminContent"
                              placeholder="답변 내용을 입력하세요." required></textarea>
                </div>

                <button type="submit" class="btn btn-primary"
                        onclick="return confirm('답변을 등록할까요?');">
                    답변 등록
                </button>
            </form>
        </div>

        <!-- ✅ 관리자 + 이미 답변 있으면 안내만 -->
        <div sec:authorize="hasAnyAuthority('ADMIN','ROLE_ADMIN')"
             th:if="${!#strings.isEmpty(inquiry.adminContent)}"
             class="text-muted mt-2">
            이미 답변이 등록되어 더 이상 수정할 수 없습니다.
        </div>

        <div class="mt-4 d-flex gap-2">
            <a th:href="@{/inquiry/list}" class="btn btn-secondary">목록</a>
        </div>

    </div>
</div>
</html>
