<header th:fragment="header"
		class="site-header"
		xmlns:th="http://www.thymeleaf.org"
		xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

	<link rel="stylesheet" th:href="@{/css/header-style.css}">
	<link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">

	<style>
		/* ë©¤ë²„ì‹­ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
		.membership-badge {
			display: inline-flex;
			align-items: center;
			padding: 2px 8px;
			border-radius: 12px;
			font-size: 0.75rem;
			font-weight: 700;
			margin-left: 6px;
			text-transform: uppercase;
			vertical-align: middle;
		}
		.badge-free {
			background-color: #f1f5f9;
			color: #64748b;
			border: 1px solid #e2e8f0;
		}
		.badge-standard {
			background-color: #eff6ff;
			color: #2563eb;
			border: 1px solid #dbeafe;
		}
		.badge-premium {
			background-color: #fffbeb;
			color: #d97706;
			border: 1px solid #fef3c7;
			box-shadow: 0 0 10px rgba(251, 191, 36, 0.2);
		}
		.d-day-text {
			font-size: 0.7rem;
			color: #ef4444;
			margin-left: 4px;
			font-weight: 600;
		}
		.role-badge {
			display: inline-flex;
			align-items: center;
			padding: 1px 6px;
			border-radius: 4px;
			font-size: 0.65rem;
			font-weight: 600;
			margin-left: 4px;
			background-color: #f8fafc;
			color: #64748b;
			border: 1px solid #e2e8f0;
			vertical-align: middle;
			text-transform: uppercase;
		}
	</style>

	<div class="header">
		<div class="header-inner">

			<!-- ë¡œê³  -->
			<a href="/" class="logo">ğŸ“ StudyLink</a>

			<!-- â­ ë³€ê²½: sec:authorize â†’ th:if + sec:authorize -->
			<!-- ë¡œê·¸ì¸ ì „ -->
			<ul class="header-nav" th:if="${#authorization.expression('isAnonymous()')}">
				<li>
					<a th:href="@{/room/list}" class="header-nav-link">ë¬¸ì œ ë¦¬ìŠ¤íŠ¸</a>
				</li>
				<li>
					<a th:href="@{/chatbot}" class="header-nav-link">AI ëŒ€ì… ìƒë‹´</a>
				</li>
				<li>
					<a th:href="@{/board/list}" class="header-nav-link">ëŒ€í•™ìƒí™œ ê²Œì‹œíŒ</a>
				</li>
				<li>
					<a th:href="@{/login}" class="header-nav-link">ë¡œê·¸ì¸</a>
				</li>
				<li>
					<a th:href="@{/signup}" class="header-nav-link">íšŒì›ê°€ì…</a>
				</li>
			</ul>

			<!-- ë¡œê·¸ì¸ í›„ -->
			<ul class="header-nav" th:if="${#authorization.expression('isAuthenticated()')}">
				<li>
					<a th:href="@{/room/list}" class="header-nav-link">ë¬¸ì œ ë¦¬ìŠ¤íŠ¸</a>
				</li>
				<li>
					<a th:href="@{/chatbot}" class="header-nav-link">AI ëŒ€ì… ìƒë‹´</a>
				</li>
				<li>
					<a th:href="@{/board/list}" class="header-nav-link">ëŒ€í•™ìƒí™œ ê²Œì‹œíŒ</a>
				</li>
				<li><a th:href="@{/dashboard}" class="header-nav-link">ëŒ€ì‹œë³´ë“œ</a></li>

				<li class="dropdown">
					<a href="#"
					   class="header-nav-link dropdown-toggle"
					   id="userDropdown"
					   role="button"
					   data-toggle="dropdown"
					   aria-expanded="false"
					   style="cursor: pointer;" >

						<!-- ğŸ‘¤ <span th:text="${#authentication.principal.attributes['name']}"></span> --->
						<!-- ğŸ‘¤ <span th:text="${#authentication.name}"></span> -->

						<!-- OAuth2 ë¡œê·¸ì¸(Google/Kakao/Naver)ì—ì„œëŠ” name, ë¡œì»¬ í¼ ë¡œê·¸ì¸ì—ì„œëŠ” username ì‚¬ìš© -->
						<!--
						<span th:with="userName=${
							#authentication.principal.attributes != null && #authentication.principal.attributes['name'] != null
								? #authentication.principal.attributes['name']
								: #authentication.name
						}" th:text="${userName}">
						</span>
						-->

						<!-- ì´ë¦„ (ì†Œì…œ ë¡œê·¸ì¸ íŒ¨ì¹˜ ì™„ë£Œ) -->
						<!--
						ğŸ‘¤ <span th:text="${
							   #authentication.principal instanceof T(org.springframework.security.oauth2.core.user.DefaultOAuth2User)
								 ? #authentication.principal.attributes['name']
								 : #authentication.name
							}">
							</span>
						-->

						<!-- ì´ë¦„ + ROLE -->
						<!--
						ğŸ‘¤ <span th:text="${
						   #authentication.principal instanceof T(org.springframework.security.oauth2.core.user.DefaultOAuth2User)
							? #authentication.principal.attributes['name'] + ' [' + #authentication.principal.attributes.get('role') + ']'
							: #authentication.name + ' [' + #authentication.principal.authorities[0].authority.substring(5) + ']'
						}">
						</span>
						-->

						<!-- ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
						<span th:text="|${userName} [${userRole}]|"></span>

						<p th:text="'DEBUG userName = ' + ${userName}"></p>
						<p th:text="'DEBUG userRole = ' + ${userRole}"></p>
						-->


						<span th:if="${userName != null}">
							<span th:text="${userName}"></span>
							<!-- ì—­í•  ë±ƒì§€ -->
							<span th:if="${userRole != null && userRole != 'GUEST'}" 
								  class="role-badge" 
								  th:text="${userRole}">
							</span>
							<!-- ë©¤ë²„ì‹­ ë±ƒì§€ -->
							<span th:if="${membership != null}" 
								  th:class="'membership-badge badge-' + ${membership.toLowerCase()}"
								  th:text="${membership}">
							</span>
							<!-- D-Day í‘œì‹œ -->
							<span th:if="${membershipExpiresAt != null}" id="membershipDDay" class="d-day-text"></span>
						</span>

						<span th:if="${userName == null}">
							Guest
						</span>

					</a>

					<ul class="dropdown-menu dropdown-menu-right">
						<li><a class="dropdown-item" href="/mentor/edit-profile">ë©˜í†  í”„ë¡œí•„</a></li>
						<li><a class="dropdown-item" href="/auth/student-verification">ë©˜í†  ì¸ì¦</a></li>
						<li><a class="dropdown-item" href="/my-page"> í™˜ê²½ì„¤ì • </a></li>
						<li><hr class="dropdown-divider"></li>
						<li>
							<form method="post" th:action="@{/logout}" style="display: inline; width: 100%;">
								<button type="submit" class="dropdown-item" style="background: none; border: none; cursor: pointer; text-align: left; width: 100%; padding: 10px 16px;">
									ë¡œê·¸ì•„ì›ƒ
								</button>
							</form>
						</li>
					</ul>
				</li>

			</ul>



			<!-- ì•Œë¦¼ ë° í…Œë§ˆ ë„êµ¬ -->
			<div class="header-tools">
				<!-- í…Œë§ˆ í† ê¸€ (ëª¨ë“  ìœ ì €) -->
				<button id="themeToggle" class="tool-btn" title="í…Œë§ˆ ë³€ê²½">
					<span class="theme-icon sun-icon">â˜€ï¸</span>
					<span class="theme-icon moon-icon" style="display: none;">ğŸŒ™</span>
				</button>

				<!-- ì•Œë¦¼ (ë¡œê·¸ì¸ ìœ ì €ë§Œ) -->
				<div class="notification-wrapper" sec:authorize="isAuthenticated()">
					<button id="notiBell" class="tool-btn" title="ì•Œë¦¼ í™•ì¸">
						<span class="bell-icon">ğŸ””</span>
						<span id="notiBadge" class="noti-badge" style="display: none;">0</span>
					</button>
					
					<!-- ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ íŒ¨ë„ -->
					<div id="notiPanel" class="noti-panel">
						<div class="noti-header">
							<h3>ì•Œë¦¼</h3>
							<button id="markAllRead" class="btn-text">ëª¨ë‘ ì½ìŒ</button>
						</div>
						<div id="notiList" class="noti-list">
							<!-- ì•Œë¦¼ í•­ëª©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
							<div class="noti-empty">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
						</div>
						<div class="noti-footer">
							<a href="/my-page" class="btn-text">ì „ì²´ ë³´ê¸°</a>
						</div>
					</div>
				</div>
			</div>

			<!-- D-Day -->
			<div class="header-buttons">
				<div class="dday">
					<p>ìˆ˜ëŠ¥ê¹Œì§€ </p>
					<span th:attr="data-dday=${dday}" th:text="${dday}"></span>
				</div>
			</div>

		</div>
	</div>

	<script th:inline="javascript">
		/* ë©¤ë²„ì‹­ D-Day ê³„ì‚° */
		document.addEventListener('DOMContentLoaded', function() {
			const expiresAtStr = /*[[${membershipExpiresAt}]]*/ null;
			if (expiresAtStr) {
				const expiresAt = new Date(expiresAtStr);
				const now = new Date();
				const diffTime = expiresAt - now;
				const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
				
				const dDayElement = document.getElementById('membershipDDay');
				if (dDayElement) {
					if (diffDays > 0) {
						dDayElement.innerText = '(D-' + diffDays + ')';
					} else if (diffDays === 0) {
						dDayElement.innerText = '(D-Day)';
					} else {
						dDayElement.innerText = '(ë§Œë£Œ)';
						dDayElement.style.color = '#94a3b8';
					}
				}
			}
		});
	</script>
</header>

