<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layout/layout}">

<div layout:fragment="content" class="container-md">
	<!-- ì œëª© -->
	<div class="title">
		<h1>ğŸ‰ ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h1>
		<p>ì…ì‹œ ì¤€ë¹„ì— í•„ìš”í•œ ì—¬ëŸ¬ê°€ì§€ ê¸°ëŠ¥ì„ ì´ì œ ììœ ë¡­ê²Œ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆì–´ìš”.</p>
	</div>

	<!-- êµ¬ë… ì •ë³´ -->
	<div class="section">
		<h2>êµ¬ë… ì •ë³´</h2>
		<ul class="info-list">
			<li>
				<strong>ìƒí’ˆëª…</strong>
				<span id="orderName"></span>
			</li>
			<li>
				<strong>êµ¬ë… ê¸°ê°„</strong>
				<span id="period"></span>
			</li>
			<li>
				<strong>ê²°ì œ ê¸ˆì•¡</strong>
				<span id="totalAmount"></span>
			</li>
			<li>
				<strong>ê²°ì œ ìˆ˜ë‹¨</strong>
				<span id="method"></span>
			</li>
			<li>
				<strong>ê²°ì œ ì¼ì‹œ</strong>
				<span id="approvedAt"></span>
			</li>
			<li>
				<strong>ì£¼ë¬¸ ë²ˆí˜¸</strong>
				<span id="orderId"></span>
			</li>
		</ul>

		<ul class="features">
			<li>[ì´ìš© ê°€ëŠ¥ ê¸°ëŠ¥ 1]</li>
			<li>[ì´ìš© ê°€ëŠ¥ ê¸°ëŠ¥ 2]</li>
			<li>[ì´ìš© ê°€ëŠ¥ ê¸°ëŠ¥ 3]</li>
		</ul>
	</div>

	<!-- ì•¡ì…˜ ë²„íŠ¼ -->
	<div class="actions">
		<a href="/dashboard" class="btn-primary">ë‚´ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™</a>
		<a href="/" class="btn-secondary">ë°”ë¡œ ì‹œì‘í•˜ê¸°(í•µì‹¬ ê¸°ëŠ¥ URL ì—°ê²°í•˜ê¸°)</a>
	</div>

	<!-- ì•ˆë‚´ -->
	<div class="section">
		<h2>ğŸ§¾ ì´ìš© ì•ˆë‚´</h2>
		<div class="notice">
			<p>Â· êµ¬ë… ê¸°ëŠ¥ì€ ê²°ì œ ì¦‰ì‹œ í™œì„±í™”ë©ë‹ˆë‹¤.</p>
			<p>Â· ê²°ì œ ë‚´ì—­ì€ <strong>ë§ˆì´í˜ì´ì§€ &gt; ê²°ì œ ê´€ë¦¬</strong>ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
			<p>Â· ë¬¸ì˜ì‚¬í•­ì€ ê³ ê°ì„¼í„° ë˜ëŠ” 1:1 ë¬¸ì˜ë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”.</p>
		</div>
	</div>

	<script>
		// ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ê°’ì´ ê²°ì œ ìš”ì²­í•  ë•Œ ë³´ë‚¸ ë°ì´í„°ì™€ ë™ì¼í•œì§€ ë°˜ë“œì‹œ í™•ì¸í•˜ì„¸ìš”.
		// í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê²°ì œ ê¸ˆì•¡ì„ ì¡°ì‘í•˜ëŠ” í–‰ìœ„ë¥¼ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
		const urlParams = new URLSearchParams(window.location.search);
		const paymentKey = urlParams.get("paymentKey");
		const orderId = urlParams.get("orderId");
		const amount = urlParams.get("amount");

		async function confirm() {
		    const requestData = {
				paymentKey: paymentKey,
				orderId: orderId,
				amount: amount,
		    };

		    const response = await fetch("/payment/confirm", {
				method: "POST",
				headers: {
			    	"Content-Type": "application/json",
				},
				body: JSON.stringify(requestData),
		    });

		    const json = await response.json();

		    if (!response.ok) {
				// ê²°ì œ ì‹¤íŒ¨ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ êµ¬í˜„í•˜ì„¸ìš”.
				window.location.href = `/payment/fail`;
		    }

			// ê²°ì œì¼ íŒŒì‹±
			const approvedDate = new Date(json.approvedAt);

				// ì¢…ë£Œì¼ = ê²°ì œì¼ + 30ì¼
			const endDate = new Date(approvedDate);
			endDate.setDate(endDate.getDate() + 30);

			// ë‚ ì§œ í¬ë§· í•¨ìˆ˜ (YYYY.MM.DD)
			function formatDate(date) {
				const y = date.getFullYear();
				const m = String(date.getMonth() + 1).padStart(2, '0');
				const d = String(date.getDate()).padStart(2, '0');
				return `${y}.${m}.${d}`;
			}

		    // ê²°ì œ ì„±ê³µ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ êµ¬í˜„í•˜ì„¸ìš”.
			const orderNameElement = document.getElementById("orderName");
			const periodElement = document.getElementById("period");
			const totalAmountElement = document.getElementById("totalAmount");
			const methodElement = document.getElementById("method");
			const approvedAtElement = document.getElementById("approvedAt");
			const orderIdElement = document.getElementById("orderId");

			orderNameElement.textContent = json.orderName;
			periodElement.textContent = `${formatDate(approvedDate)} ~ ${formatDate(endDate)}`;
			totalAmountElement.textContent = json.totalAmount + "ì›";
			methodElement.textContent = json.method;
			approvedAtElement.textContent = json.approvedAt;
			orderIdElement.textContent = json.orderId;
		}
		confirm();


	</script>
</div>
