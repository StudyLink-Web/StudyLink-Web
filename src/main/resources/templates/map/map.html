<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/layout}"
>
  <head>
    <meta charset="UTF-8" />
    <title>ì…ì‹œ ì§€ë„ - StudyLink</title>
    <style>
      .map-container-wrapper {
        display: flex;
        height: calc(100vh - 100px);
        margin-top: 10px;
        gap: 15px;
      }

      .map-sidebar {
        width: 300px;
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        gap: 20px;
        overflow-y: auto;
      }

      .map-content {
        flex: 1;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
      }

      #map {
        width: 100%;
        height: 100%;
      }

      .sim-section {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 15px;
      }

      .sim-section:last-child {
        border-bottom: none;
      }

      .sim-title {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 10px;
        color: #333;
      }

      .input-group-text {
        width: 80px;
        justify-content: center;
      }

      .mode-toggle-btn {
        width: 100%;
        margin-top: 10px;
      }

      /* ë°˜ì‘í˜• */
      @media (max-width: 991px) {
        .map-container-wrapper {
          flex-direction: column;
          height: auto;
        }
        .map-sidebar {
          width: 100%;
          height: auto;
        }
        #map {
          height: 500px;
        }
      }
      /* í”„ë¦¬ë¯¸ì—„ ì»¤ìŠ¤í…€ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
      .premium-marker {
        position: relative;
        width: 30px;
        height: 40px;
        cursor: pointer;
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .premium-marker:hover {
        transform: translateY(-5px) scale(1.1);
        z-index: 100 !important;
      }
      .marker-svg {
        filter: drop-shadow(0 3px 5px rgba(0, 0, 0, 0.3));
      }
      .marker-circle {
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 10px;
        height: 10px;
        background: white;
        border-radius: 50%;
      }
      /* íˆìŠ¤í† ë¦¬ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
      .history-item {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 10px 12px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 4px solid #667eea;
      }
      .history-item:hover {
        transform: translateX(3px);
        background: #f8f9ff;
        border-color: #667eea;
      }
      .history-item .title {
        font-weight: 600;
        font-size: 0.85rem;
        color: #333;
        display: block;
        margin-bottom: 3px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .history-item .date {
        font-size: 0.75rem;
        color: #999;
      }

      /* ë¶„ì„ ëª¨ë“œ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
      .analysis-mode-badge {
        font-size: 0.75rem;
        padding: 6px 12px;
        border-radius: 20px;
        background: #eef2ff;
        color: #4f46e5;
        border: 1px solid #c7d2fe;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 15px;
        animation: fadeIn 0.3s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ë±ƒì§€ ì»¤ìŠ¤í…€ */
      .simulation-mode-badge {
        background: #f1f5f9;
        color: #64748b;
        border-color: #e2e8f0;
      }
    </style>
  </head>

  <div layout:fragment="content" class="container-fluid">
    <div class="map-container-wrapper">
      <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°”: ì„±ì  ì‹œë®¬ë ˆì´í„° -->
      <aside class="map-sidebar">
        <div class="sim-section">
          <div class="sim-title">ğŸ“Š ê°€ìƒ ì„±ì  ì„¤ì •</div>
          <p class="text-muted small">
            ë“±ê¸‰ì„ ì¡°ì ˆí•˜ì—¬ ì§€ì› ê°€ëŠ¥í•œ ëŒ€í•™ì„ í™•ì¸í•´ë³´ì„¸ìš”.
          </p>

          <!-- [NEW] ë¶„ì„ ëª¨ë“œ í‘œì‹œê¸° -->
          <div id="analysisModeIndicator">
            <div
              id="modeBadge"
              class="analysis-mode-badge simulation-mode-badge"
            >
              <i id="modeIcon" class="fas fa-chart-line"></i>
              <span id="analysisModeText">ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ í™œì„±í™”</span>
              <button
                id="modeCloseBtn"
                type="button"
                class="btn-close d-none"
                style="font-size: 0.5rem; margin-left: auto"
                onclick="resetToSimMode()"
              ></button>
            </div>
          </div>

          <!-- êµ­ì–´ ë“±ê¸‰ -->
          <div class="mb-4">
            <label
              for="korGrade"
              class="form-label d-flex justify-content-between align-items-center"
            >
              <span>êµ­ì–´ ë“±ê¸‰</span>
              <div>
                <span id="korVal" class="badge bg-primary me-1">3</span>
                <span id="korBadge" class="badge bg-light text-dark border"
                  >ìƒìœ„ 23%</span
                >
              </div>
            </label>
            <input
              type="range"
              class="form-range"
              id="korGrade"
              min="1"
              max="9"
              step="1"
              value="3"
            />
          </div>

          <!-- ìˆ˜í•™ ë“±ê¸‰ -->
          <div class="mb-4">
            <label
              for="matGrade"
              class="form-label d-flex justify-content-between align-items-center"
            >
              <span>ìˆ˜í•™ ë“±ê¸‰</span>
              <div>
                <span id="matVal" class="badge bg-primary me-1">3</span>
                <span id="matBadge" class="badge bg-light text-dark border"
                  >ìƒìœ„ 23%</span
                >
              </div>
            </label>
            <input
              type="range"
              class="form-range"
              id="matGrade"
              min="1"
              max="9"
              step="1"
              value="3"
            />
          </div>

          <div
            class="alert alert-secondary py-2 px-2 small mb-4"
            style="font-size: 0.8rem; background-color: #f1f3f5; color: #6c757d"
          >
            * íƒêµ¬/ì˜ì–´ëŠ” êµ­/ìˆ˜ í‰ê· ìœ¼ë¡œ ìë™ ë°˜ì˜
          </div>
        </div>

        <div class="sim-section">
          <div class="sim-title">ğŸ›  ì‹œê°í™” ëª¨ë“œ</div>
          <button id="viewToggle" class="btn btn-outline-info mode-toggle-btn">
            ğŸ”„ ì…ì‹œ ì§€í˜•ë„ë¡œ ì „í™˜
          </button>
        </div>

        <!-- ì„±ëŠ¥ ì•ˆë‚´ ë©”ì‹œì§€ ì˜ì—­ -->
        <div
          id="performanceNotice"
          class="alert alert-info py-2 px-3 small d-none mt-3"
          style="font-size: 0.75rem"
        >
          <i class="fas fa-info-circle me-1"></i> ìƒìœ„ 50ê°œ ê²°ê³¼ë§Œ í‘œì‹œ
          ì¤‘ì…ë‹ˆë‹¤.
        </div>

        <div class="sim-section mt-auto" th:if="${isAuthenticated}">
          <div
            class="sim-title d-flex justify-content-between align-items-center"
          >
            <span>ğŸ•’ ì„±ì  íˆìŠ¤í† ë¦¬</span>
            <button
              id="refreshHistoryBtn"
              class="btn btn-sm btn-link text-decoration-none p-0"
              title="ìƒˆë¡œê³ ì¹¨"
            >
              <i class="fas fa-sync-alt" style="font-size: 0.8rem"></i>
            </button>
          </div>
          <div
            id="historyList"
            class="list-group list-group-flush gap-2"
            style="max-height: 250px; overflow-y: auto"
          >
            <div class="text-center py-3 text-muted small">
              ì„±ì  ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
          </div>
        </div>

        <div class="sim-section mt-auto" th:unless="${isAuthenticated}">
          <div class="alert alert-info py-2 small mb-0">
            ğŸ’¡ <strong>Tip!</strong> ë¡œê·¸ì¸í•˜ì‹œë©´ ì €ì¥ëœ ë‚´ ì„±ì  ì´ë ¥ì„ ë¶ˆëŸ¬ì™€ì„œ
            ë¹„êµí•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>
      </aside>

      <!-- ìš°ì¸¡ ì§€ë„ ì˜ì—­ -->
      <main class="map-content">
        <!-- ì§€ë„ê°€ ê·¸ë ¤ì§ˆ ì˜ì—­ -->
        <div id="map"></div>

        <!-- 'ì´ ì§€ì—­ ì¬ê²€ìƒ‰' ë²„íŠ¼ -->
        <button
          id="refreshBtn"
          class="btn btn-primary btn-sm shadow-sm"
          style="
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            border-radius: 20px;
            padding: 8px 20px;
            font-weight: 600;
          "
        >
          <i class="fas fa-sync-alt me-1"></i> ì´ ì§€ì—­ ì¬ê²€ìƒ‰
        </button>

        <!-- ì§€ë„ ì•ˆë‚´ ì˜¤ë²„ë ˆì´ (ì´ˆê¸° ë¡œë”© ì‹œë§Œ í‘œì‹œ) -->
        <div
          id="map-overlay"
          style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            pointer-events: none;
            text-align: center;
          "
        >
          <h5 class="mb-0">ğŸ“ ì…ì‹œ ì§€ë„ ì—”ì§„ ë¡œë”© ì¤‘...</h5>
          <small class="text-muted">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</small>
        </div>
      </main>
    </div>

    <!-- ì¹´ì¹´ì˜¤ ë§µ SDK ë¡œë“œ (autoload=false ì‚¬ìš©í•˜ì—¬ ì•ˆì •ì ì¸ ì´ˆê¸°í™”) -->
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=96d7cc705078c2f63da6039b9f9879ce&autoload=false"
    ></script>

    <script th:inline="javascript">
      let kakaoMap = null;
      let markers = [];
      let infoWindow = null;

      // [NEW] ì „ì—­ ì •ë°€ ì„±ì  ë°ì´í„° ìƒíƒœ
      let activeFullScores = null;
      let activeHistoryTitle = null;

      // 1. ì¹´ì¹´ì˜¤ ë§µ ë¡œë“œ í›„ ì´ˆê¸°í™”
      kakao.maps.load(function () {
        const container = document.getElementById("map");
        const options = {
          center: new kakao.maps.LatLng(36.5, 127.5),
          level: 12,
        };
        kakaoMap = new kakao.maps.Map(container, options);
        infoWindow = new kakao.maps.InfoWindow({ zIndex: 1 });

        // ì§€ë„ ë¡œë“œ ì™„ë£Œ í›„ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸° ë° ë°ì´í„° ë¡œë“œ
        document.getElementById("map-overlay").style.display = "none";
        loadMapData();
      });

      // 2. ë°ì´í„° í˜¸ì¶œ ë° ë Œë”ë§ í•¨ìˆ˜
      let abortController = null;
      async function loadMapData() {
        if (!kakaoMap) return;

        // ì´ì „ ìš”ì²­ì´ ìˆë‹¤ë©´ ì·¨ì†Œ
        if (abortController) {
          abortController.abort();
        }
        abortController = new AbortController();

        const bounds = kakaoMap.getBounds();
        const sw = bounds.getSouthWest();
        const ne = bounds.getNorthEast();

        let requestData = {
          userScores: [],
          bounds: {
            minLat: sw.getLat(),
            maxLat: ne.getLat(),
            minLng: sw.getLng(),
            maxLng: ne.getLng(),
          },
        };

        // [NEW] ì •ë°€ ë¶„ì„ ëª¨ë“œì¸ ê²½ìš° full score ì‚¬ìš©, ì•„ë‹ˆë©´ ìŠ¬ë¼ì´ë” ê¸°ë°˜ ì‹œë®¬ë ˆì´ì…˜
        if (activeFullScores && activeFullScores.length > 0) {
          console.log("ğŸš€ [MapAPI] ì •ë°€ ë¶„ì„ ëª¨ë“œ ë°ì´í„° ì „ì†¡:", activeFullScores);
          requestData.userScores = activeFullScores.map((s) => ({
            subjectName: s.subject_name || s.subjectName,
            score: s.score,
            scoreType: s.score_type || s.scoreType,
            category: s.category,
          }));
        } else {
          const kor = document.getElementById("korGrade").value;
          const mat = document.getElementById("matGrade").value;
          console.log("ğŸ› ï¸ [MapAPI] ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ë°ì´í„° ì „ì†¡ (ë“±ê¸‰ ê¸°ë°˜)");
          requestData.userScores = [
            {
              subjectName: "êµ­ì–´",
              score: parseInt(kor),
              scoreType: "ë“±ê¸‰",
              category: "ê³µí†µ",
            },
            {
              subjectName: "ìˆ˜í•™",
              score: parseInt(mat),
              scoreType: "ë“±ê¸‰",
              category: "ê³µí†µ",
            },
          ];
        }

        try {
          const response = await fetch("/map/api/data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
            signal: abortController.signal,
          });
          const data = await response.json();
          console.log("ì „ì²´ ì‘ë‹µ ë°ì´í„°:", data);

          if (!data || !data.items) {
            console.error("ì„œë²„ ì‘ë‹µ ê²°ê³¼ì— itemsê°€ ì—†ìŠµë‹ˆë‹¤.");
            renderMarkers([]);
            return;
          }

          console.log(`ì´ ${data.items.length}ê°œì˜ ë°ì´í„°ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.`);
          renderMarkers(data.items);
        } catch (error) {
          if (error.name === "AbortError") {
            console.log("ì´ì „ ìš”ì²­ ì·¨ì†Œë¨");
          } else {
            console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
            alert(
              "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
            );
          }
        }
      }

      function getStatusColor(status) {
        if (status === "ì•ˆì •") return "#28a745"; // Green
        if (status === "ì ì •") return "#007bff"; // Blue
        if (status === "ì†Œì‹ ") return "#fd7e14"; // Orange
        if (status === "ë¶ˆê°€") return "#dc3545"; // Red
        return "#6c757d"; // Grey
      }

      function createMarkerContent(item, count) {
        const color = getStatusColor(item.status);

        // í•™ê³¼ ê°œìˆ˜ê°€ 1ê°œ ì´ìƒì´ë©´ ë±ƒì§€ í‘œì‹œ
        const badgeHtml =
          count > 1
            ? `<div style="position:absolute; top:-5px; right:-5px; background:#ffc107; color:#000; font-size:10px; font-weight:bold; border-radius:50%; width:18px; height:18px; display:flex; align-items:center; justify-content:center; border:1px solid white; box-shadow:0 2px 4px rgba(0,0,0,0.2);">${count}</div>`
            : "";

        const div = document.createElement("div");
        div.className = "premium-marker";
        div.innerHTML = `
          <svg class="marker-svg" width="30" height="40" viewBox="0 0 32 40" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M16 40C16 40 32 24.5 32 16C32 7.16344 24.8366 0 16 0C7.16344 0 0 7.16344 0 16C0 24.5 16 40 16 40Z" fill="${color}"/>
            <circle cx="16" cy="16" r="6" fill="white"/>
          </svg>
          ${badgeHtml}
        `;
        return div;
      }

      function renderMarkers(items) {
        if (!items) items = [];

        // ê¸°ì¡´ ë§ˆì»¤(ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´) ì œê±°
        markers.forEach((m) => m.setMap(null));
        markers = [];

        // 1. ëŒ€í•™ë³„ë¡œ ë°ì´í„° ê·¸ë£¹í•‘ (Clustering)
        const univGroups = {};
        items.forEach((item) => {
          if (!univGroups[item.univ]) {
            univGroups[item.univ] = [];
          }
          univGroups[item.univ].push(item);
        });

        const univKeys = Object.keys(univGroups);
        console.log(
          `í´ëŸ¬ìŠ¤í„°ë§ ê²°ê³¼: ì´ ${univKeys.length}ê°œì˜ ëŒ€í•™ ê·¸ë£¹ ìƒì„±`
        );

        // ìµœìƒìœ„ 50ê°œ ëŒ€í•™ë§Œ ì¶”ì¶œ (ì„±ëŠ¥ ìµœì í™”)
        const displayUnivs = univKeys.slice(0, 50);

        // ì•ˆë‚´ ë©”ì‹œì§€ ì œì–´
        const notice = document.getElementById("performanceNotice");
        if (notice) {
          if (univKeys.length > 50) {
            notice.classList.remove("d-none");
            notice.innerHTML = `<i class="fas fa-info-circle me-1"></i> ìƒìœ„ 50ê°œ ëŒ€í•™ë§Œ í‘œì‹œ ì¤‘ì…ë‹ˆë‹¤. (ì „ì²´: ${univKeys.length}ê°œ)`;
          } else {
            notice.classList.add("d-none");
          }
        }

        displayUnivs.forEach((univName) => {
          const groupItems = univGroups[univName];
          const representative = groupItems[0]; // ëŒ€í‘œ ì•„ì´í…œ (ì¢Œí‘œìš©)
          const count = groupItems.length; // í•™ê³¼ ê°œìˆ˜

          const position = new kakao.maps.LatLng(
            representative.lat,
            representative.lng
          );

          // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ìƒì„± (ë§ˆì»¤ ì´ë¯¸ì§€ ëŒ€ì‹  CSS ì‚¬ìš© + ê°œìˆ˜ ë±ƒì§€)
          const content = createMarkerContent(representative, count);

          const overlay = new kakao.maps.CustomOverlay({
            position: position,
            content: content,
            yAnchor: 1.0,
          });

          overlay.setMap(kakaoMap);

          // í´ë¦­ ì´ë²¤íŠ¸ (CustomOverlayëŠ” DOM ì—˜ë¦¬ë¨¼íŠ¸ì— ì§ì ‘ ì´ë²¤íŠ¸ ë“±ë¡ ê°€ëŠ¥)
          content.onclick = function () {
            // [Fix] ì •ë³´ì°½ ë‚´ìš© ë‹¨ìˆœí™” (UI ê°œì„ )
            // 1. ëŒ€í‘œ í•©ê²©ì„  ê³„ì‚° (ê°€ì¥ ì²« ë²ˆì§¸ í•™ê³¼ í˜¹ì€ í‰ê· )
            let rep_per = representative.target_per;
            if (rep_per < 1 && rep_per > 0)
              rep_per = (rep_per * 100).toFixed(1);

            // 2. ë¦¬ìŠ¤íŠ¸ ìƒì„± (ì ìˆ˜ ì œê±°, í•™ê³¼ëª…ë§Œ ê¹”ë”í•˜ê²Œ)
            let listHtml =
              '<ul style="padding-left:0; list-style:none; max-height:200px; overflow-y:auto; margin-bottom:0;">';

            groupItems.forEach((gItem) => {
              listHtml += `
                    <li style="padding:6px 0; border-bottom:1px solid #eee; display:flex; align-items:center;">
                        <span style="font-size:0.9rem; color:#333;">â€¢ ${gItem.major}</span>
                    </li>
                `;
            });
            listHtml += "</ul>";

            const infoContent = `
              <div style="padding:15px; min-width:280px; font-family: 'Noto Sans KR', sans-serif; border-radius:10px;">
                <h6 class="mb-1 d-flex justify-content-between align-items-center" style="color:#2c3e50; font-weight:700; font-size:1rem;">
                    <a href="${
                      representative.univ_url ||
                      "https://search.naver.com/search.naver?query=" +
                        representative.univ +
                        " ê³µì‹í™ˆí˜ì´ì§€"
                    }"
                       target="_blank"
                       title="ê³µì‹ í™ˆí˜ì´ì§€ ë°”ë¡œê°€ê¸°"
                       style="text-decoration:none; color:inherit; cursor:pointer;"
                       onmouseover="this.style.color='#007bff'"
                       onmouseout="this.style.color='inherit'">
                        ${
                          representative.univ
                        } <i class="fas fa-external-link-alt" style="font-size:0.75rem; color:#007bff; margin-left:3px;"></i>
                    </a>
                    <span class="badge ${getStatusBadgeClass(
                      representative.status
                    )}">${representative.status}</span>
                </h6>
                <div class="mb-2 d-flex justify-content-between" style="font-size:0.8rem; color:#7f8c8d;">
                    <span>${representative.region} / ${
              representative.category
            }</span>
                    <span class="text-primary fw-bold">í‰ê·  í•©ê²©ì„ : ${rep_per}%</span>
                </div>
                <div class="alert alert-light border small py-1 px-2 mb-2 text-center" style="font-size:0.75rem; color:#666;">
                    ì´ <strong>${count}ê°œ</strong> í•™ê³¼ ì§€ì› ê°€ëŠ¥
                </div>
                <hr class="my-2">
                ${listHtml}
              </div>
            `;
            infoWindow.setContent(infoContent);
            // InfoWindowë¥¼ í•´ë‹¹ ìœ„ì¹˜ì— ì—´ê¸°
            infoWindow.setPosition(position);
            infoWindow.open(kakaoMap);
          };

          markers.push(overlay);
        });
      }

      function getStatusBadgeClass(status) {
        switch (status) {
          case "ì•ˆì •":
            return "bg-success";
          case "ì ì •":
            return "bg-primary";
          case "ì†Œì‹ ":
            return "bg-warning text-dark";
          case "ë¶ˆê°€":
            return "bg-danger";
          default:
            return "bg-secondary";
        }
      }

      // 4. ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë°”ì¸ë”©
      let timer;
      const gradePercentMap = {
        1: "ìƒìœ„ 4%",
        2: "ìƒìœ„ 11%",
        3: "ìƒìœ„ 23%",
        4: "ìƒìœ„ 40%",
        5: "ìƒìœ„ 60%",
        6: "ìƒìœ„ 77%",
        7: "ìƒìœ„ 89%",
        8: "ìƒìœ„ 96%",
        9: "ìƒìœ„ 100%",
      };

      function handleGradeChange(e, valId, badgeId) {
        // [NEW] ìŠ¬ë¼ì´ë” ì¡°ì‘ ì‹œ ì •ë°€ ë¶„ì„ ëª¨ë“œ í•´ì œ
        if (activeFullScores) {
          console.log("â™»ï¸ ìŠ¬ë¼ì´ë” ì¡°ì‘ ê°ì§€: ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì „í™˜");
          resetToSimMode(false); // UIë§Œ ê°±ì‹ í•˜ê³  ë°ì´í„° í˜¸ì¶œì€ timerì—ì„œ ìˆ˜í–‰
        }

        const val = e.target.value;
        document.getElementById(valId).innerText = val;

        // ë±ƒì§€ ì—…ë°ì´íŠ¸
        const badge = document.getElementById(badgeId);
        if (badge) badge.innerText = gradePercentMap[val] || "";

        clearTimeout(timer);
        timer = setTimeout(() => {
          loadMapData();
        }, 400);
      }

      document
        .getElementById("korGrade")
        .addEventListener("input", (e) =>
          handleGradeChange(e, "korVal", "korBadge")
        );
      document
        .getElementById("matGrade")
        .addEventListener("input", (e) =>
          handleGradeChange(e, "matVal", "matBadge")
        );

      // 5. 'ì´ ì§€ì—­ ì¬ê²€ìƒ‰' ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById("refreshBtn").onclick = function () {
        loadMapData();
      };

      // 6. ì…ì‹œ ì§€í˜•ë„(ìœ„ì„± ëª¨ë“œ) í† ê¸€ êµ¬í˜„
      const viewToggleBtn = document.getElementById("viewToggle");
      let isSatellite = false;

      viewToggleBtn.onclick = function () {
        isSatellite = !isSatellite;

        if (isSatellite) {
          // ìœ„ì„± ëª¨ë“œ (SKYVIEW) + ë¼ë²¨ (HYBRID íš¨ê³¼)
          kakaoMap.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
          viewToggleBtn.innerHTML = "ğŸ—ºï¸ ì¼ë°˜ ì§€ë„ë¡œ ì „í™˜";
          viewToggleBtn.classList.remove("btn-outline-info");
          viewToggleBtn.classList.add("btn-info", "text-white");
        } else {
          // ì¼ë°˜ ëª¨ë“œ (ROADMAP)
          kakaoMap.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);
          viewToggleBtn.innerHTML = "ğŸ”„ ì…ì‹œ ì§€í˜•ë„ë¡œ ì „í™˜";
          viewToggleBtn.classList.remove("btn-info", "text-white");
          viewToggleBtn.classList.add("btn-outline-info");
        }
      };

      // [NEW] ëª¨ë“œ ì „í™˜ ë° UI ê°±ì‹  í•¨ìˆ˜
      function resetToSimMode(refreshData = true) {
        activeFullScores = null;
        activeHistoryTitle = null;

        const badge = document.getElementById("modeBadge");
        const icon = document.getElementById("modeIcon");
        const text = document.getElementById("analysisModeText");
        const closeBtn = document.getElementById("modeCloseBtn");

        if (badge && icon && text && closeBtn) {
          badge.className = "analysis-mode-badge simulation-mode-badge";
          icon.className = "fas fa-chart-line";
          text.innerText = "ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ í™œì„±í™”";
          closeBtn.classList.add("d-none");
        }

        if (refreshData) {
          clearTimeout(timer);
          loadMapData();
        }
      }

      function updateAnalysisModeUI(title) {
        const badge = document.getElementById("modeBadge");
        const icon = document.getElementById("modeIcon");
        const text = document.getElementById("analysisModeText");
        const closeBtn = document.getElementById("modeCloseBtn");

        if (badge && icon && text && closeBtn) {
          badge.className = "analysis-mode-badge"; // Indigo
          icon.className = "fas fa-microscope";
          text.innerText = `'${title}' ì •ë°€ ë¶„ì„ ì¤‘`;
          closeBtn.classList.remove("d-none");
        }
      }

      // 7. ë‚´ ì„±ì  ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥ (ì´ì „ ì¤‘ë³µ ë²„íŠ¼ ì œê±°ë¡œ ì¸í•´ ê¸°ëŠ¥ë§Œ ë³´ì¡´ - íˆìŠ¤í† ë¦¬ë¥¼ í†µí•´ ìš°íšŒ ê¶Œì¥)
      // ì‹¤ì œ loadScoreBtnì€ ìœ„ì—ì„œ ì œê±°ë˜ì—ˆì§€ë§Œ ë¡œì§ì€ ë‚¨ê²¨ë‘˜ ìˆ˜ ìˆìœ¼ë‚˜ ì—¬ê¸°ì„œëŠ” ì•„ì˜ˆ ì‚­ì œí•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•¨.

      // 8. ì„±ì  íˆìŠ¤í† ë¦¬ ë¡œë“œ ë° ë Œë”ë§ [NEW]
      async function loadScoreHistory() {
        const historyList = document.getElementById("historyList");
        if (!historyList) return;

        try {
          const res = await fetch("/api/dashboard/records");
          if (!res.ok) throw new Error("íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨");
          const records = await res.json();

          if (records && records.length > 0) {
            historyList.innerHTML = "";
            records.slice(0, 5).forEach((r) => {
              const date = new Date(r.createdAt).toLocaleDateString();
              const item = document.createElement("div");
              item.className = "history-item";
              item.innerHTML = `
                <span class="title">${r.title}</span>
                <span class="date">${date} ì €ì¥ë¨</span>
              `;
              item.onclick = () => selectHistoryRecord(r.id, r.title);
              historyList.appendChild(item);
            });
          } else {
            historyList.innerHTML = `
                <div class="alert alert-light border small py-2 mb-0" style="font-size: 0.75rem; color: #666;">
                    ğŸ’¡ <strong>Tip!</strong> ëŒ€ì‹œë³´ë“œì—ì„œ ì„±ì ì„ ì €ì¥í•˜ë©´ ì—¬ê¸°ì— ë‚´ì—­ì´ í‘œì‹œë©ë‹ˆë‹¤.
                </div>`;
          }
        } catch (e) {
          console.error(e);
          historyList.innerHTML =
            '<div class="text-danger small py-2 text-center">íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
      }

      async function selectHistoryRecord(id, title) {
        try {
          const res = await fetch(`/api/dashboard/records/${id}/load`);
          if (!res.ok) throw new Error("ì„±ì  ë¡œë“œ ì‹¤íŒ¨");
          const scores = await res.json();

          if (scores && scores.length > 0) {
            // [NEW] ì •ë°€ ë¶„ì„ ëª¨ë“œ í™œì„±í™” ë° ì „ì—­ ìƒíƒœ ì €ì¥
            activeFullScores = scores;
            activeHistoryTitle = title;
            updateAnalysisModeUI(title);

            scores.forEach((s) => {
              const sName = s.subject_name || s.subjectName;
              const sType = s.score_type || s.scoreType;
              const sScore = s.score;

              // ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸ (ì°¸ê³ ìš© - ë“±ê¸‰ ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ)
              if (sType === "ë“±ê¸‰") {
                if (sName === "êµ­ì–´") {
                  const el = document.getElementById("korGrade");
                  el.value = sScore;
                  handleGradeChange({ target: el }, "korVal", "korBadge");
                }
                if (sName === "ìˆ˜í•™") {
                  const el = document.getElementById("matGrade");
                  el.value = sScore;
                  handleGradeChange({ target: el }, "matVal", "matBadge");
                }
              }
            });
            clearTimeout(timer);
            loadMapData();
            console.log(`[ScoreHistory] Loaded Precise Mode: ${title}`);
          }
        } catch (e) {
          console.error(e);
          alert("ì„±ì ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì´ˆê¸°í™”: ì¸ì¦ëœ ê²½ìš° íˆìŠ¤í† ë¦¬ ë¡œë“œ
      const isAuthenticated = [[${isAuthenticated}]];
      if (isAuthenticated) {
        loadScoreHistory();
        const refreshBtn = document.getElementById("refreshHistoryBtn");
        if (refreshBtn) {
          refreshBtn.onclick = function (e) {
            e.stopPropagation();
            loadScoreHistory();
          };
        }
      }
    </script>
  </div>
</html>
