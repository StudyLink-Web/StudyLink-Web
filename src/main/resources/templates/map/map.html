<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/layout}"
>
  <head>
    <meta charset="UTF-8" />
    <title>ì…ì‹œ ì§€ë„ - StudyLink</title>
    <style>
      .map-container-wrapper {
        display: flex;
        height: calc(100vh - 100px);
        margin-top: 10px;
        gap: 15px;
      }

      .map-sidebar {
        width: 300px;
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        gap: 20px;
        overflow-y: auto;
      }

      .map-content {
        flex: 1;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
      }

      #map {
        width: 100%;
        height: 100%;
      }

      .sim-section {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 15px;
      }

      .sim-section:last-child {
        border-bottom: none;
      }

      .sim-title {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 10px;
        color: #333;
      }

      .input-group-text {
        width: 80px;
        justify-content: center;
      }

      .mode-toggle-btn {
        width: 100%;
        margin-top: 10px;
      }

      /* ë°˜ì‘í˜• */
      @media (max-width: 991px) {
        .map-container-wrapper {
          flex-direction: column;
          height: auto;
        }
        .map-sidebar {
          width: 100%;
          height: auto;
        }
        #map {
          height: 500px;
        }
      }
    </style>
  </head>

  <div layout:fragment="content" class="container-fluid">
    <div class="map-container-wrapper">
      <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°”: ì„±ì  ì‹œë®¬ë ˆì´í„° -->
      <aside class="map-sidebar">
        <div class="sim-section">
          <div class="sim-title">ğŸ“Š ê°€ìƒ ì„±ì  ì„¤ì •</div>
          <p class="text-muted small">
            ë“±ê¸‰ì„ ì¡°ì ˆí•˜ì—¬ ì§€ì› ê°€ëŠ¥í•œ ëŒ€í•™ì„ í™•ì¸í•´ë³´ì„¸ìš”.
          </p>

          <!-- ìˆ˜ëŠ¥ ë°±ë¶„ìœ„ -->
          <div class="mb-4">
            <label
              for="csatRange"
              class="form-label d-flex justify-content-between"
            >
              <span>ìˆ˜ëŠ¥ ë°±ë¶„ìœ„</span>
              <span id="csatVal" class="badge bg-primary">90</span>
            </label>
            <input
              type="range"
              class="form-range"
              id="csatRange"
              min="0"
              max="100"
              step="1"
              value="90"
            />
          </div>

          <!-- ë‚´ì‹  ë“±ê¸‰ -->
          <div class="mb-4">
            <label
              for="gpaRange"
              class="form-label d-flex justify-content-between"
            >
              <span>ë‚´ì‹  ë“±ê¸‰</span>
              <span id="gpaVal" class="badge bg-success">2.0</span>
            </label>
            <input
              type="range"
              class="form-range"
              id="gpaRange"
              min="1.0"
              max="9.0"
              step="0.1"
              value="2.0"
            />
          </div>
        </div>

        <div class="sim-section">
          <div class="sim-title">ğŸ›  ì‹œê°í™” ëª¨ë“œ</div>
          <button id="viewToggle" class="btn btn-outline-info mode-toggle-btn">
            ğŸ”„ ì…ì‹œ ì§€í˜•ë„ë¡œ ì „í™˜
          </button>
        </div>

        <div class="sim-section mt-auto">
          <div class="alert alert-info py-2 small mb-0">
            ğŸ’¡ <strong>Tip!</strong> ëŒ€ì‹œë³´ë“œê°€ ì™„ì„±ë˜ë©´ ì‹¤ì œ ë‚´ ì„±ì ì„ ë¶ˆëŸ¬ì˜¬
            ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>
      </aside>

      <!-- ìš°ì¸¡ ì§€ë„ ì˜ì—­ -->
      <main class="map-content">
        <!-- ì§€ë„ê°€ ê·¸ë ¤ì§ˆ ì˜ì—­ -->
        <div id="map"></div>

        <!-- ì§€ë„ ì•ˆë‚´ ì˜¤ë²„ë ˆì´ (ì´ˆê¸° ë¡œë”© ì‹œë§Œ í‘œì‹œ) -->
        <div
          id="map-overlay"
          style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            pointer-events: none;
            text-align: center;
          "
        >
          <h5 class="mb-0">ğŸ“ ì…ì‹œ ì§€ë„ ì—”ì§„ ë¡œë”© ì¤‘...</h5>
          <small class="text-muted">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</small>
        </div>
      </main>
    </div>

    <!-- ì¹´ì¹´ì˜¤ ë§µ SDK ë¡œë“œ (autoload=false ì‚¬ìš©í•˜ì—¬ ì•ˆì •ì ì¸ ì´ˆê¸°í™”) -->
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=96d7cc705078c2f63da6039b9f9879ce&autoload=false"
    ></script>

    <script th:inline="javascript">
      let kakaoMap = null;
      let markers = [];
      let infoWindow = null;

      // 1. ì¹´ì¹´ì˜¤ ë§µ ë¡œë“œ í›„ ì´ˆê¸°í™”
      kakao.maps.load(function () {
        const container = document.getElementById("map");
        const options = {
          center: new kakao.maps.LatLng(36.5, 127.5),
          level: 12,
        };
        kakaoMap = new kakao.maps.Map(container, options);
        infoWindow = new kakao.maps.InfoWindow({ zIndex: 1 });

        // ì§€ë„ ë¡œë“œ ì™„ë£Œ í›„ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸° ë° ë°ì´í„° ë¡œë“œ
        document.getElementById("map-overlay").style.display = "none";
        loadMapData();
      });

      // 2. ë°ì´í„° í˜¸ì¶œ ë° ë Œë”ë§ í•¨ìˆ˜
      async function loadMapData() {
        if (!kakaoMap) return;

        const csat = document.getElementById("csatRange").value;
        const gpa = document.getElementById("gpaRange").value;

        const requestData = {
          userScores: [
            {
              subjectName: "êµ­ì–´",
              score: parseInt(csat),
              scoreType: "ë°±ë¶„ìœ„",
              category: "ê³µí†µ",
            },
            {
              subjectName: "ìˆ˜í•™",
              score: parseInt(csat),
              scoreType: "ë°±ë¶„ìœ„",
              category: "ê³µí†µ",
            },
            {
              subjectName: "íƒêµ¬",
              score: parseInt(csat),
              scoreType: "ë°±ë¶„ìœ„",
              category: "ì‚¬íƒ",
            },
          ],
        };

        try {
          const response = await fetch("/map/api/data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
          });
          const data = await response.json();
          renderMarkers(data.items);
        } catch (error) {
          console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
        }
      }

      // 3. ë§ˆì»¤ ë Œë”ë§ ë¡œì§
      function renderMarkers(items) {
        markers.forEach((m) => m.setMap(null));
        markers = [];

        items.forEach((item) => {
          const position = new kakao.maps.LatLng(item.lat, item.lng);

          const marker = new kakao.maps.Marker({
            position: position,
            title: item.univ,
            map: kakaoMap,
          });

          kakao.maps.event.addListener(marker, "click", function () {
            const content = `
              <div style="padding:15px; min-width:180px; font-family: 'Noto Sans KR', sans-serif;">
                <h6 class="mb-1" style="color:#2c3e50; font-weight:700;">${
                  item.univ
                }</h6>
                <div class="mb-2" style="font-size:0.85rem; color:#7f8c8d;">${
                  item.major
                }</div>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="badge ${getStatusBadgeClass(item.status)}">${
              item.status
            }</span>
                  <span class="text-primary" style="font-size:0.8rem; font-weight:600;">ì…ê²°: ${
                    item.target_per
                  }%</span>
                </div>
              </div>
            `;
            infoWindow.setContent(content);
            infoWindow.open(kakaoMap, marker);
          });

          markers.push(marker);
        });
      }

      function getStatusBadgeClass(status) {
        switch (status) {
          case "ì•ˆì •":
            return "bg-success";
          case "ì ì •":
            return "bg-primary";
          case "ì†Œì‹ ":
            return "bg-warning text-dark";
          case "ë¶ˆê°€":
            return "bg-danger";
          default:
            return "bg-secondary";
        }
      }

      // 4. ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë°”ì¸ë”©
      let timer;
      function handleSliderChange(e, valId) {
        document.getElementById(valId).innerText = e.target.value;
        clearTimeout(timer);
        timer = setTimeout(() => {
          loadMapData();
        }, 400); // ë„‰ë„‰í•˜ê²Œ 400ms ëŒ€ê¸°
      }

      document
        .getElementById("csatRange")
        .addEventListener("input", (e) => handleSliderChange(e, "csatVal"));
      document.getElementById("gpaRange").addEventListener("input", (e) => {
        document.getElementById("gpaVal").innerText = parseFloat(
          e.target.value
        ).toFixed(1);
        handleSliderChange(e, "gpaVal");
      });
    </script>
  </div>
</html>
